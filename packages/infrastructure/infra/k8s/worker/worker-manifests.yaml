apiVersion: apps/v1
kind: Deployment
metadata:
  name: worker-deployment
  namespace: express-nest-app
  labels:
    app: express-nest-blueprint
    component: worker
spec:
  replicas: 1
  selector:
    matchLabels:
      app: express-nest-blueprint
      component: worker
  template:
    metadata:
      labels:
        app: express-nest-blueprint
        component: worker
    spec:
      dnsConfig:
        options:
          - name: ndots
            value: "1"
      containers:
      - name: worker
        image: express-nest-blueprint:latest
        imagePullPolicy: IfNotPresent
        command: ["node", "packages/backend/core-api/dist/main.js"]
        envFrom:
        - configMapRef:
            name: app-config
        - secretRef:
            name: app-secrets
        env:
        - name: APP_ROLE
          value: "WORKER"
        resources:
          limits:
            cpu: "1000m"
            memory: "384Mi"
          requests:
            cpu: "200m"
            memory: "128Mi"
        livenessProbe:
          exec:
            command: ["pgrep", "-f", "node packages/backend/core-api/dist/main.js"]
          initialDelaySeconds: 15
          periodSeconds: 20
        readinessProbe:
          exec:
            command: ["pgrep", "-f", "node packages/backend/core-api/dist/main.js"]
          initialDelaySeconds: 5
          periodSeconds: 10
      - name: metrics-proxy
        image: node:20-alpine
        command: ["node", "-e"]
        args:
          - |
            const http = require('http');
            const secret = process.env.HEALTH_CHECK_SECRET;
            http.createServer((req, res) => {
              const options = { hostname: 'localhost', port: 3000, path: '/api/v1/metrics', method: 'GET', headers: { 'X-Health-Key': secret } };
              http.request(options, (p) => { res.writeHead(p.statusCode, p.headers); p.pipe(res); }).on('error', () => { res.writeHead(503); res.end(); }).end();
            }).listen(9100);
        env:
          - name: HEALTH_CHECK_SECRET
            valueFrom:
              secretKeyRef:
                name: app-secrets
                key: HEALTH_CHECK_SECRET
        resources:
          limits:
            cpu: '100m'
            memory: '64Mi'
          requests:
            cpu: '50m'
            memory: '32Mi'
        ports:
          - containerPort: 9100
            name: metrics
        livenessProbe:
          httpGet:
            path: /
            port: 9100
          initialDelaySeconds: 2
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /
            port: 9100
          initialDelaySeconds: 2
          periodSeconds: 10