<div class="database-page animate-fade-in">
  <div class="page-header" appDraggableResizable="database-header">
    <div class="header-content">
      <h2>Architectural Explorer</h2>
      <p class="text-muted">Direct oversight and manipulation of relational entity matrices</p>
    </div>
    <div class="header-actions" appDraggableResizable="database-header-actions">
      <app-toggle-switch
        [label]="'GraphQL Mode'"
        [checked]="useGraphQL()"
        (toggle)="delegate.onGraphQLToggleWrapper($event)"
        style="margin-right: 1.5rem; transform: scale(0.9);"
      ></app-toggle-switch>
      <button class="btn btn-primary" (click)="delegate.refreshSchemaWrapper()" [disabled]="loadingSchema()" title="Force fresh schema" appDraggableResizable="database-refresh-schema-btn">
        <span class="material-icons" [class.spin]="loadingSchema()">hub</span>
        Re-scan Infrastructure
      </button>
    </div>
  </div>

  <div *ngIf="loadingSchema()" class="schema-skeleton">
    <div class="skeleton-line glass mb-4" *ngFor="let i of [1,2,3]"></div>
  </div>

  <div class="schema-tree" *ngIf="!loadingSchema() && schema()">
    <div *ngFor="let category of schema() | keyvalue" class="category-block glass" [appDraggableResizable]="'database-category-' + category.key">
      <div class="category-header" (click)="delegate.toggleCategoryWrapper(category.key)">
        <span class="material-icons chevron" [class.expanded]="expandedCategories()[category.key]">expand_more</span>
        <span class="material-icons category-icon">folder_special</span>
        <span class="category-name">{{ category.key }}</span>
        <span class="badge">{{ category.value.length }} entities</span>
      </div>

      <div class="tables-list" *ngIf="expandedCategories()[category.key]">
        <div *ngFor="let table of category.value" class="table-node" [class.active]="selectedTable()?.name === table.name">
          <div class="table-header" (click)="delegate.selectTableWrapper(table)">
            <span class="material-icons chevron-sm" [class.expanded]="selectedTable()?.name === table.name">play_arrow</span>
            <span class="material-icons table-icon">table_chart</span>
            <span class="table-name">{{ table.displayName }}</span>
            <span class="table-meta">[{{ table.tableName }}]</span>
          </div>

          <!-- Dynamic CRUD Interface Expanded Inside the Tree -->
          <div class="crud-expansion glass" *ngIf="selectedTable()?.name === table.name" [appDraggableResizable]="'database-crud-' + table.name">
            <div class="crud-controls">
              <div class="search-box glass">
                <span class="material-icons search-icon">search</span>
                <input type="text" [placeholder]="'Search ' + table.displayName + '...'" (input)="delegate.onSearchWrapper($event)">
              </div>
              <div class="crud-actions">
                <button 
                  *ngIf="table.actions?.create !== false"
                  class="btn btn-sm btn-primary" 
                  (click)="createRecord()" 
                  title="Add new record">
                  <span class="material-icons">add</span>
                  <span>Add Record</span>
                </button>
                <button class="btn btn-sm btn-secondary" (click)="delegate.refreshTableDataWrapper()" [disabled]="loadingData()" title="Refresh table data">
                  <span class="material-icons" [class.spin]="loadingData()">refresh</span>
                </button>
                <div class="crud-stats text-muted">
                  {{ total() }} records discovered
                </div>
              </div>
            </div>

            <!-- Scroll hint for wide tables -->
            <div class="scroll-hint" *ngIf="table.columns.length > 6">
              <span class="material-icons">swipe</span>
              <span>Scroll horizontally to view all columns</span>
            </div>

            <div class="table-scroll-container" #tableScrollContainer>
              <div *ngIf="loadingData()" class="shimmer-overlay"></div>
              
              <table class="crud-table">
                <thead>
                  <tr>
                    <th *ngFor="let col of table.columns" 
                        [class]="delegate.getHeaderClassesWrapper(col.name, col.type)"
                        [ngStyle]="delegate.getColumnStylesWrapper(col.name, col.type)">
                      <span>{{ delegate.getFieldDisplayNameWrapper(col.name) }}</span>
                    </th>
                    <th *ngIf="delegate.hasAnyActionsWrapper(selectedTable())" class="header-actions text-center" style="width: 160px; min-width: 160px;">
                      <span>ACTIONS</span>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let row of tableData()" 
                      class="crud-row" 
                      [class.has-draft-changes]="delegate.hasRecordDraftWrapper(selectedTable(), delegate.getNumberValueWrapper(row, 'id'))"
                      [class.marked-for-deletion]="delegate.isRecordMarkedForDeletionWrapper(selectedTable(), delegate.getNumberValueWrapper(row, 'id'))">
                    <td *ngFor="let col of table.columns" 
                        [class]="delegate.getCellClassesWrapper(col.name, col.type)"
                        [ngStyle]="delegate.getColumnStylesWrapper(col.name, col.type)">
                      
                      <!-- Draft change indicator -->
                      <span *ngIf="delegate.hasRecordDraftWrapper(selectedTable(), delegate.getNumberValueWrapper(row, 'id')) && col === table.columns[0]" 
                            class="change-indicator" 
                            [class.delete-indicator]="delegate.isRecordMarkedForDeletionWrapper(selectedTable(), delegate.getNumberValueWrapper(row, 'id'))"
                            [title]="delegate.isRecordMarkedForDeletionWrapper(selectedTable(), delegate.getNumberValueWrapper(row, 'id')) ? 'This record is marked for deletion' : 'This record has unsaved changes'">
                      </span>
                      <!-- Boolean toggle switch -->
                      <div *ngIf="col.type === 'boolean'">
                        <app-toggle-switch 
                          [checked]="getBooleanValue(row, col.name)" 
                          [disabled]="delegate.isSensitiveFieldWrapper(col.name) && !delegate.canModifySensitiveFieldsWrapper()"
                          (toggle)="updateBooleanValue(row, col, $event)"
                          size="medium">
                        </app-toggle-switch>
                      </div>

                      <!-- Profile Image with click functionality -->
                      <div *ngIf="delegate.isImageUrlWrapper(col.name)" class="avatar-cell" (click)="handleImageClick(row, col.name)">
                        <div *ngIf="row[col.name]" class="profile-image-container">
                          <img [src]="row[col.name]" class="cell-img" [title]="'Click to view full image'">
                        </div>
                        <div *ngIf="!row[col.name]" class="logo-sm glow" [title]="'Click for image info'">
                          <span class="user-initials">{{ delegate.getUserInitialsWrapper(row) }}</span>
                        </div>
                      </div>

                      <!-- All other values (including dates) -->
                      <span *ngIf="!delegate.isImageUrlWrapper(col.name) && col.type !== 'boolean'" class="cell-content">
                        {{ delegate.formatValueWrapper(row[col.name], col) }}
                      </span>
                    </td>
                    <td *ngIf="delegate.hasAnyActionsWrapper(selectedTable())" class="cell-actions text-center" style="width: 160px;">
                      <app-action-buttons
                        [updateConfig]="{ 
                          show: selectedTable()?.actions?.update !== false, 
                          disabled: false, 
                          tooltip: 'Update Record' 
                        }"
                        [deleteConfig]="{ 
                          show: selectedTable()?.actions?.delete !== false, 
                          disabled: !delegate.canDeleteRecordWrapper(), 
                          tooltip: delegate.canDeleteRecordWrapper() ? 'Purge Record' : 'Delete restricted to Global Administrators' 
                        }"
                        (updateClick)="updateRecord(delegate.getNumberValueWrapper(row, 'id'))"
                        (deleteClick)="deleteRecord(delegate.getNumberValueWrapper(row, 'id'))"
                        size="medium">
                      </app-action-buttons>
                    </td>
                  </tr>
                  
                  <tr *ngIf="tableData().length === 0 && !loadingData()">
                    <td [attr.colspan]="table.columns.length + (delegate.hasAnyActionsWrapper(selectedTable()) ? 1 : 0)" class="empty-cell">
                      No entities found in this sector.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="pagination-footer">
              <div class="pagination-controls">
                <button class="page-btn" (click)="delegate.changePageWrapper(page() - 1)" [disabled]="page() <= 1">
                  <span class="material-icons">chevron_left</span>
                </button>
                <button *ngFor="let p of pages" 
                        class="page-btn" 
                        [class.active]="p === page()"
                        (click)="delegate.changePageWrapper(p)">
                  {{ p }}
                </button>
                <button class="page-btn" (click)="delegate.changePageWrapper(page() + 1)" [disabled]="page() >= totalPages">
                  <span class="material-icons">chevron_right</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Draft Status Bar -->
  <app-draft-status-bar 
    [config]="draftStatusConfig()"
    (saveChanges)="publishAllChanges()"
    (resetChanges)="resetAllChanges()">
  </app-draft-status-bar>

  <!-- Update Modal -->
  <div class="modal-overlay" *ngIf="delegate.showUpdateModalWrapper()" (click)="delegate.closeUpdateModalWrapper()">
    <div class="modal-content glass" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ delegate.getModalTitleWrapper() }}</h3>
        <button class="close-btn" (click)="delegate.closeUpdateModalWrapper()">
          <span class="material-icons">close</span>
        </button>
      </div>
      
      <div class="modal-body" *ngIf="selectedTable()">
        <!-- Changes summary -->
        <div *ngIf="delegate.hasFormChangesWrapper()" class="changes-summary">
          <h4>Changes to be applied:</h4>
          <ul>
            <li *ngFor="let field of delegate.getChangedFieldsWrapper()">
              <strong>{{ delegate.getFieldDisplayNameWrapper(field.name) }}:</strong>
              <span class="old-value">{{ delegate.formatFieldValueWrapper(field.oldValue) }}</span>
              →
              <span class="new-value">{{ delegate.formatFieldValueWrapper(field.newValue) }}</span>
            </li>
          </ul>
        </div>
        
        <div class="form-container">
          <ng-container *ngFor="let col of selectedTable()!.columns">
            <div class="form-field" *ngIf="col.editable && !delegate.isFieldExcludedWrapper(col.name, modal.selectedRecord()) && col.type !== 'boolean'">
              <label class="field-label">
                {{ delegate.getFieldDisplayNameWrapper(col.name) }}
                <span *ngIf="delegate.modalModeWrapper() === 'update' && delegate.isFieldChangedWrapper(col.name)" class="field-changed-indicator" title="Field has been modified">●</span>
              </label>
              
              <!-- Role dropdown (special case) -->
              <select 
                *ngIf="col.name === 'role'"
                class="form-input role-select"
                [class.disabled]="delegate.isFieldDisabledWrapper(col.name, selectedTable(), modal.modalMode())"
                [class.invalid]="delegate.isRoleInvalidWrapper()"
                [class.changed]="delegate.isFieldChangedWrapper(col.name)"
                [disabled]="delegate.isFieldDisabledWrapper(col.name, selectedTable(), modal.modalMode())"
                [(ngModel)]="delegate.updateFormDataWrapper()[col.name]"
                (ngModelChange)="delegate.updateFormFieldWrapper(col.name, $event)">
                <option value="">Select Role</option>
                <option *ngFor="let role of delegate.getAvailableRolesWrapper()" 
                        [value]="role.value">
                  {{ role.label }}
                </option>
              </select>
              
              <!-- Role validation message -->
              <div *ngIf="col.name === 'role' && delegate.isRoleInvalidWrapper()" class="validation-message">
                Please select a valid role
              </div>
              
              <!-- Text/String inputs (excluding role) -->
              <input 
                *ngIf="(col.type === 'string' || col.type === 'text') && col.name !== 'role'"
                type="text"
                class="form-input"
                [class.disabled]="delegate.isFieldDisabledWrapper(col.name, selectedTable(), modal.modalMode())"
                [class.changed]="delegate.isFieldChangedWrapper(col.name)"
                [disabled]="delegate.isFieldDisabledWrapper(col.name, selectedTable(), modal.modalMode())"
                [value]="delegate.updateFormDataWrapper()[col.name] || ''"
                (input)="delegate.updateFormFieldWrapper(col.name, $any($event.target).value)"
                [placeholder]="'Enter ' + delegate.getFieldDisplayNameWrapper(col.name)">
              
              <!-- Number inputs -->
              <input 
                *ngIf="col.type === 'number' || col.type === 'integer'"
                type="number"
                class="form-input"
                [class.disabled]="delegate.isFieldDisabledWrapper(col.name, selectedTable(), modal.modalMode())"
                [class.changed]="delegate.isFieldChangedWrapper(col.name)"
                [disabled]="delegate.isFieldDisabledWrapper(col.name, selectedTable(), modal.modalMode())"
                [value]="delegate.updateFormDataWrapper()[col.name] || ''"
                (input)="delegate.updateFormFieldWrapper(col.name, +$any($event.target).value)"
                [placeholder]="'Enter ' + delegate.getFieldDisplayNameWrapper(col.name)">

              <!-- Boolean Toggle Switch -->
              <div *ngIf="col.type === 'boolean'" class="toggle-field-wrapper">
                <app-toggle-switch
                  [checked]="$any(delegate.updateFormDataWrapper()[col.name])"
                  [disabled]="delegate.isFieldDisabledWrapper(col.name, selectedTable(), modal.modalMode())"
                  (toggle)="delegate.updateFormFieldWrapper(col.name, $event)">
                </app-toggle-switch>
                <span class="toggle-status-text">{{ delegate.updateFormDataWrapper()[col.name] ? 'Enabled' : 'Disabled' }}</span>
              </div>
            </div>
          </ng-container>

          <!-- Injected password field specifically for account/identity creation -->
          <div *ngIf="delegate.modalModeWrapper() === 'create' && delegate.updateFormDataWrapper()['password'] !== undefined && !delegate.isFieldInMetadataWrapper('password', selectedTable())" class="form-field">
            <label class="field-label">Security Key (Password)</label>
            <app-password-input
              [value]="$any(delegate.updateFormDataWrapper()['password'] || '')"
              (valueChange)="delegate.updateFormFieldWrapper('password', $event)"
              [showGenerate]="true"
              (generate)="generatePassword()"
              placeholder="Enter or generate security key">
            </app-password-input>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="delegate.closeUpdateModalWrapper()">Cancel</button>
        <button class="btn btn-primary" 
                [class.disabled]="delegate.isFormInvalidWrapper(delegate.hasFormChangesWrapper())"
                [disabled]="delegate.isFormInvalidWrapper(delegate.hasFormChangesWrapper())"
                [title]="delegate.modalModeWrapper() === 'update' ? delegate.getUpdateButtonTooltipWrapper(delegate.hasFormChangesWrapper(), delegate.getChangedFieldsWrapper().length) : 'Create New Record'"
                (click)="submitForm()">
          <span class="material-icons">{{ delegate.getSubmitButtonIconWrapper() }}</span>
          {{ delegate.getSubmitButtonTextWrapper(delegate.hasFormChangesWrapper()) }}
        </button>
      </div>
    </div>
  </div>
</div>