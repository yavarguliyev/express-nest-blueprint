<div class="database-page animate-fade-in">
  <div class="page-header" appDraggableResizable="database-header">
    <div class="header-content">
      <h2>Architectural Explorer</h2>
      <p class="text-muted">Direct oversight and manipulation of relational entity matrices</p>
    </div>
    <div class="header-actions" appDraggableResizable="database-header-actions">
      <app-toggle-switch
        [label]="'GraphQL Mode'"
        [checked]="useGraphQL()"
        (toggleChange)="useGraphQL.set($event); refreshSchema()"
        style="margin-right: 1.5rem; transform: scale(0.9);"
      ></app-toggle-switch>
      <button class="btn btn-primary" (click)="refreshSchema()" [disabled]="loadingSchema()" title="Force fresh schema" appDraggableResizable="database-refresh-schema-btn">
        <span class="material-icons" [class.spin]="loadingSchema()">hub</span>
        Re-scan Infrastructure
      </button>
    </div>
  </div>

  <div *ngIf="loadingSchema()" class="schema-skeleton">
    <div class="skeleton-line glass mb-4" *ngFor="let i of [1,2,3]"></div>
  </div>

  <div class="schema-tree" *ngIf="!loadingSchema() && schema()">
    <div *ngFor="let category of schema() | keyvalue" class="category-block glass" [appDraggableResizable]="'database-category-' + category.key">
      <div class="category-header" (click)="toggleCategory(category.key)">
        <span class="material-icons chevron" [class.expanded]="expandedCategories()[category.key]">expand_more</span>
        <span class="material-icons category-icon">folder_special</span>
        <span class="category-name">{{ category.key }}</span>
        <span class="badge">{{ category.value.length }} entities</span>
      </div>

      <div class="tables-list" *ngIf="expandedCategories()[category.key]">
        <div *ngFor="let table of category.value" class="table-node" [class.active]="selectedTable()?.name === table.name">
          <div class="table-header" (click)="selectTable(table)">
            <span class="material-icons chevron-sm" [class.expanded]="selectedTable()?.name === table.name">play_arrow</span>
            <span class="material-icons table-icon">table_chart</span>
            <span class="table-name">{{ table.displayName }}</span>
            <span class="table-meta">[{{ table.tableName }}]</span>
          </div>

          <!-- Dynamic CRUD Interface Expanded Inside the Tree -->
          <div class="crud-expansion glass" *ngIf="selectedTable()?.name === table.name" [appDraggableResizable]="'database-crud-' + table.name">
            <div class="crud-controls">
              <div class="search-box glass">
                <span class="material-icons search-icon">search</span>
                <input type="text" [placeholder]="'Search ' + table.displayName + '...'" (input)="onSearch($event)">
              </div>
              <div class="crud-actions">
                <button 
                  *ngIf="table.actions?.create !== false"
                  class="btn btn-sm btn-primary" 
                  (click)="createRecord()" 
                  title="Add new record">
                  <span class="material-icons">add</span>
                  <span>Add Record</span>
                </button>
                <button class="btn btn-sm btn-secondary" (click)="refreshTableData()" [disabled]="loadingData()" title="Refresh table data">
                  <span class="material-icons" [class.spin]="loadingData()">refresh</span>
                </button>
                <div class="crud-stats text-muted">
                  {{ total() }} records discovered
                </div>
              </div>
            </div>

            <!-- Scroll hint for wide tables -->
            <div class="scroll-hint" *ngIf="table.columns.length > 6">
              <span class="material-icons">swipe</span>
              <span>Scroll horizontally to view all columns</span>
            </div>

            <div class="table-scroll-container" #tableScrollContainer>
              <div *ngIf="loadingData()" class="shimmer-overlay"></div>
              
              <table class="crud-table">
                <thead>
                  <tr>
                    <th *ngFor="let col of table.columns" 
                        [class]="getHeaderClasses(col.name, col.type)"
                        [ngStyle]="getColumnStyles(col.name, col.type)">
                      <span>{{ getFieldDisplayName(col.name) }}</span>
                    </th>
                    <th *ngIf="hasAnyActions()" class="header-actions text-center" style="width: 160px; min-width: 160px;">
                      <span>ACTIONS</span>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let row of tableData()" 
                      class="crud-row" 
                      [class.has-draft-changes]="hasRecordDraft(getNumberValue(row, 'id'))"
                      [class.marked-for-deletion]="isRecordMarkedForDeletion(getNumberValue(row, 'id'))">
                    <td *ngFor="let col of table.columns" 
                        [class]="getCellClasses(col.name, col.type)"
                        [ngStyle]="getColumnStyles(col.name, col.type)">
                      
                      <!-- Draft change indicator -->
                      <span *ngIf="hasRecordDraft(getNumberValue(row, 'id')) && col === table.columns[0]" 
                            class="change-indicator" 
                            [class.delete-indicator]="isRecordMarkedForDeletion(getNumberValue(row, 'id'))"
                            [title]="isRecordMarkedForDeletion(getNumberValue(row, 'id')) ? 'This record is marked for deletion' : 'This record has unsaved changes'">
                      </span>
                      <!-- Boolean toggle switch -->
                      <div *ngIf="col.type === 'boolean'">
                        <app-toggle-switch 
                          [checked]="getBooleanValue(row, col.name)" 
                          [disabled]="isSensitiveField(col.name) && !canModifySensitiveFields()"
                          (toggleChange)="updateBooleanValue(row, col, $event)"
                          size="medium">
                        </app-toggle-switch>
                      </div>

                      <!-- Profile Image with click functionality -->
                      <div *ngIf="isImageUrl(col.name)" class="avatar-cell" (click)="handleImageClick(row, col.name)">
                        <div *ngIf="row[col.name]" class="profile-image-container">
                          <img [src]="row[col.name]" class="cell-img" [title]="'Click to view full image'">
                        </div>
                        <div *ngIf="!row[col.name]" class="logo-sm glow" [title]="'Click for image info'">
                          <span class="user-initials">{{ getUserInitials(row) }}</span>
                        </div>
                      </div>

                      <!-- All other values (including dates) -->
                      <span *ngIf="!isImageUrl(col.name) && col.type !== 'boolean'" class="cell-content">
                        {{ formatValue(row[col.name], col) }}
                      </span>
                    </td>
                    <td *ngIf="hasAnyActions()" class="cell-actions text-center" style="width: 160px;">
                      <app-action-buttons
                        [updateConfig]="{ 
                          show: selectedTable()?.actions?.update !== false, 
                          disabled: false, 
                          tooltip: 'Update Record' 
                        }"
                        [deleteConfig]="{ 
                          show: selectedTable()?.actions?.delete !== false, 
                          disabled: !canDeleteRecord(), 
                          tooltip: canDeleteRecord() ? 'Purge Record' : 'Delete restricted to Global Administrators' 
                        }"
                        (updateClick)="updateRecord(getNumberValue(row, 'id'))"
                        (deleteClick)="deleteRecord(getNumberValue(row, 'id'))"
                        size="medium">
                      </app-action-buttons>
                    </td>
                  </tr>
                  
                  <tr *ngIf="tableData().length === 0 && !loadingData()">
                    <td [attr.colspan]="table.columns.length + (hasAnyActions() ? 1 : 0)" class="empty-cell">
                      No entities found in this sector.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="pagination-footer">
              <div class="pagination-controls">
                <button class="page-btn" (click)="changePage(page() - 1)" [disabled]="page() <= 1">
                  <span class="material-icons">chevron_left</span>
                </button>
                <button *ngFor="let p of pages" 
                        class="page-btn" 
                        [class.active]="p === page()"
                        (click)="changePage(p)">
                  {{ p }}
                </button>
                <button class="page-btn" (click)="changePage(page() + 1)" [disabled]="page() >= totalPages">
                  <span class="material-icons">chevron_right</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Draft Status Bar -->
  <app-draft-status-bar 
    [config]="draftStatusConfig()"
    (saveChanges)="publishAllChanges()"
    (resetChanges)="resetAllChanges()">
  </app-draft-status-bar>

  <!-- Update Modal -->
  <div class="modal-overlay" *ngIf="showUpdateModal()" (click)="closeUpdateModal()">
    <div class="modal-content glass" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ getModalTitle() }}</h3>
        <button class="close-btn" (click)="closeUpdateModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      
      <div class="modal-body" *ngIf="selectedTable()">
        <!-- Changes summary -->
        <div *ngIf="hasFormChanges()" class="changes-summary">
          <h4>Changes to be applied:</h4>
          <ul>
            <li *ngFor="let field of getChangedFields()">
              <strong>{{ getFieldDisplayName(field.name) }}:</strong>
              <span class="old-value">{{ formatFieldValue(field.oldValue) }}</span>
              →
              <span class="new-value">{{ formatFieldValue(field.newValue) }}</span>
            </li>
          </ul>
        </div>
        
        <div class="form-container">
          <ng-container *ngFor="let col of selectedTable()!.columns">
            <div class="form-field" *ngIf="col.editable && !isFieldExcluded(col.name) && col.type !== 'boolean'">
              <label class="field-label">
                {{ getFieldDisplayName(col.name) }}
                <span *ngIf="modalMode() === 'update' && isFieldChanged(col.name)" class="field-changed-indicator" title="Field has been modified">●</span>
              </label>
              
              <!-- Role dropdown (special case) -->
              <select 
                *ngIf="col.name === 'role'"
                class="form-input role-select"
                [class.disabled]="isFieldDisabled(col.name)"
                [class.invalid]="isRoleInvalid()"
                [class.changed]="isFieldChanged(col.name)"
                [disabled]="isFieldDisabled(col.name)"
                [(ngModel)]="updateFormData()[col.name]"
                (ngModelChange)="updateFormField(col.name, $event)">
                <option value="">Select Role</option>
                <option *ngFor="let role of getAvailableRoles()" 
                        [value]="role.value">
                  {{ role.label }}
                </option>
              </select>
              
              <!-- Role validation message -->
              <div *ngIf="col.name === 'role' && isRoleInvalid()" class="validation-message">
                Please select a valid role
              </div>
              
              <!-- Text/String inputs (excluding role) -->
              <input 
                *ngIf="(col.type === 'string' || col.type === 'text') && col.name !== 'role'"
                type="text"
                class="form-input"
                [class.disabled]="isFieldDisabled(col.name)"
                [class.changed]="isFieldChanged(col.name)"
                [disabled]="isFieldDisabled(col.name)"
                [value]="updateFormData()[col.name] || ''"
                (input)="updateFormField(col.name, $any($event.target).value)"
                [placeholder]="'Enter ' + getFieldDisplayName(col.name)">
              
              <!-- Number inputs -->
              <input 
                *ngIf="col.type === 'number' || col.type === 'integer'"
                type="number"
                class="form-input"
                [class.disabled]="isFieldDisabled(col.name)"
                [class.changed]="isFieldChanged(col.name)"
                [disabled]="isFieldDisabled(col.name)"
                [value]="updateFormData()[col.name] || ''"
                (input)="updateFormField(col.name, +$any($event.target).value)"
                [placeholder]="'Enter ' + getFieldDisplayName(col.name)">

              <!-- Boolean Toggle Switch -->
              <div *ngIf="col.type === 'boolean'" class="toggle-field-wrapper">
                <app-toggle-switch
                  [checked]="$any(updateFormData()[col.name])"
                  [disabled]="isFieldDisabled(col.name)"
                  (toggleChange)="updateFormField(col.name, $event)">
                </app-toggle-switch>
                <span class="toggle-status-text">{{ updateFormData()[col.name] ? 'Enabled' : 'Disabled' }}</span>
              </div>
            </div>
          </ng-container>

          <!-- Injected password field specifically for account/identity creation -->
          <div *ngIf="modalMode() === 'create' && updateFormData()['password'] !== undefined && !isFieldInMetadata('password')" class="form-field">
            <label class="field-label">Security Key (Password)</label>
            <app-password-input
              [value]="$any(updateFormData()['password'] || '')"
              (valueChange)="updateFormField('password', $event)"
              [showGenerate]="true"
              (generate)="generatePassword()"
              placeholder="Enter or generate security key">
            </app-password-input>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeUpdateModal()">Cancel</button>
        <button class="btn btn-primary" 
                [class.disabled]="isFormInvalid()"
                [disabled]="isFormInvalid()"
                [title]="modalMode() === 'update' ? getUpdateButtonTooltip() : 'Create New Record'"
                (click)="submitForm()">
          <span class="material-icons">{{ getSubmitButtonIcon() }}</span>
          {{ getSubmitButtonText() }}
        </button>
      </div>
    </div>
  </div>
</div>